<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مقسم الصور والفريمات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .checkerboard {
            background-color: #f0f0f0;
            background-image:
                linear-gradient(45deg, #ccc 25%, transparent 25%),
                linear-gradient(-45deg, #ccc 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ccc 75%),
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-indigo-700 mb-2">مقسم الفريمات والصور</h1>
            <p class="text-gray-600">أداة بسيطة لفصل الصور المجمعة (Sprite Sheets) إلى ملفات منفصلة.</p>
        </header>

        <main class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
            
            <!-- قسم التحكم والرفع -->
            <div class="p-6 border-b border-gray-200 bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
                    
                    <!-- منطقة الرفع -->
                    <div class="w-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">اختر الصورة</label>
                        <div class="flex items-center justify-center w-full">
                            <label for="dropzone-file" class="flex flex-col items-center justify-center w-full h-40 border-2 border-indigo-300 border-dashed rounded-lg cursor-pointer bg-indigo-50 hover:bg-indigo-100 transition">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-8 h-8 mb-4 text-indigo-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                                    </svg>
                                    <p class="text-sm text-gray-500"><span class="font-semibold">اضغط للرفع</span> أو اسحب الصورة هنا</p>
                                </div>
                                <input id="dropzone-file" type="file" class="hidden" accept="image/*" />
                            </label>
                        </div>
                    </div>

                    <!-- إعدادات التقسيم -->
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <h3 class="font-bold text-blue-800 mb-3">إعدادات الشبكة</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">الأعمدة (أفقي)</label>
                                    <input type="number" id="cols" value="4" min="1" class="w-full p-2 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">الصفوف (رأسي)</label>
                                    <input type="number" id="rows" value="4" min="1" class="w-full p-2 border border-gray-300 rounded focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>
                        
                        <button id="process-btn" disabled class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed font-bold shadow-md">
                            فصل الصور الآن
                        </button>
                    </div>
                </div>
            </div>

            <!-- قسم المعاينة -->
            <div id="preview-section" class="hidden p-6 border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-4">معاينة الشبكة</h3>
                <div class="relative w-full overflow-auto bg-gray-800 rounded-lg p-4 flex justify-center">
                    <div class="relative inline-block" id="image-container">
                        <img id="source-image" src="" alt="Source" class="max-w-full h-auto block shadow-lg">
                        <!-- Grid Overlay will be injected here via JS -->
                        <div id="grid-overlay" class="absolute inset-0 pointer-events-none border border-red-500/50"></div>
                    </div>
                </div>
            </div>

            <!-- قسم النتائج -->
            <div id="results-section" class="hidden p-6 bg-gray-50">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-gray-800">الصور المستخرجة (<span id="count-badge">0</span>)</h3>
                    <button id="download-all-btn" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition shadow flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        تحميل الكل (ZIP)
                    </button>
                </div>
                
                <div id="output-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <!-- Slices will be appended here -->
                </div>
            </div>

        </main>
        
        <footer class="text-center mt-12 text-gray-500 text-sm">
            تم الإنشاء بواسطة Gemini
        </footer>
    </div>

    <script>
        // Elements
        const fileInput = document.getElementById('dropzone-file');
        const sourceImage = document.getElementById('source-image');
        const imageContainer = document.getElementById('image-container');
        const gridOverlay = document.getElementById('grid-overlay');
        const colsInput = document.getElementById('cols');
        const rowsInput = document.getElementById('rows');
        const processBtn = document.getElementById('process-btn');
        const previewSection = document.getElementById('preview-section');
        const resultsSection = document.getElementById('results-section');
        const outputGrid = document.getElementById('output-grid');
        const countBadge = document.getElementById('count-badge');
        const downloadAllBtn = document.getElementById('download-all-btn');

        let originalImageWidth = 0;
        let originalImageHeight = 0;
        let generatedBlobs = []; // Store blobs for zip

        // Handle File Upload
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                sourceImage.src = event.target.result;
                sourceImage.onload = function() {
                    originalImageWidth = this.naturalWidth;
                    originalImageHeight = this.naturalHeight;
                    
                    previewSection.classList.remove('hidden');
                    resultsSection.classList.add('hidden');
                    processBtn.disabled = false;
                    
                    updateGridOverlay();
                    
                    // Scroll to preview
                    previewSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
            reader.readAsDataURL(file);
        });

        // Update Grid Overlay on input change
        [colsInput, rowsInput].forEach(input => {
            input.addEventListener('input', updateGridOverlay);
        });

        function updateGridOverlay() {
            if (!sourceImage.src) return;

            const cols = parseInt(colsInput.value) || 1;
            const rows = parseInt(rowsInput.value) || 1;

            // Clear previous grid
            gridOverlay.innerHTML = '';
            
            // Set grid template
            gridOverlay.style.display = 'grid';
            gridOverlay.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gridOverlay.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

            // Create cells
            const totalCells = cols * rows;
            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'border border-red-500/50 shadow-[inset_0_0_10px_rgba(255,0,0,0.2)] hover:bg-red-500/10 transition-colors duration-75';
                gridOverlay.appendChild(cell);
            }
        }

        // Process / Split Image
        processBtn.addEventListener('click', async function() {
            const cols = parseInt(colsInput.value) || 1;
            const rows = parseInt(rowsInput.value) || 1;
            
            outputGrid.innerHTML = '';
            generatedBlobs = [];
            
            const pieceWidth = originalImageWidth / cols;
            const pieceHeight = originalImageHeight / rows;

            resultsSection.classList.remove('hidden');
            countBadge.innerText = cols * rows;

            // Create canvas to draw pieces
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = pieceWidth;
            canvas.height = pieceHeight;

            let count = 0;

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    count++;
                    
                    // Clear canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw slice
                    ctx.drawImage(
                        sourceImage, 
                        x * pieceWidth, y * pieceHeight, pieceWidth, pieceHeight, // Source
                        0, 0, pieceWidth, pieceHeight // Destination
                    );

                    // Convert to Blob and display
                    await new Promise(resolve => {
                        canvas.toBlob(blob => {
                            // Store for ZIP
                            generatedBlobs.push({
                                blob: blob,
                                name: `split_${count}.png`
                            });

                            // Create display element
                            const url = URL.createObjectURL(blob);
                            const card = document.createElement('div');
                            card.className = "bg-white p-2 rounded shadow checkerboard flex flex-col items-center group relative";
                            card.innerHTML = `
                                <div class="w-full aspect-square flex items-center justify-center overflow-hidden mb-2">
                                    <img src="${url}" class="max-w-full max-h-full object-contain">
                                </div>
                                <span class="text-xs text-gray-500 font-mono">#${count}</span>
                                <a href="${url}" download="split_${count}.png" class="absolute top-2 right-2 bg-indigo-600 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition shadow hover:bg-indigo-700" title="تحميل">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                    </svg>
                                </a>
                            `;
                            outputGrid.appendChild(card);
                            resolve();
                        }, 'image/png');
                    });
                }
            }
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        });

        // Download All as ZIP
        downloadAllBtn.addEventListener('click', function() {
            if (generatedBlobs.length === 0) return;

            const zip = new JSZip();
            const folder = zip.folder("images");

            generatedBlobs.forEach(item => {
                folder.file(item.name, item.blob);
            });

            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "split_images.zip");
            });
        });

    </script>
</body>
</html>
